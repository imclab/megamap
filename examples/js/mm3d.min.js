var mm3d=mm3d||{};
mm3d.Util=function(){var c=function(a){this._e=document.createElement(a)};c.prototype={attr:function(a){for(var b in a)this._e[b]=a[b];return this},css:function(a){for(var b in a)this._e.style[b]=a[b];return this},html:function(a){if(void 0===a)return this._e.innerHTML;this._e.innerHTML=a;return this},add:function(a){this._e.appendChild(a.get());return this},w:function(a){if(void 0===a)return this._e.style.width;this._e.style.width=a+"px";return this},h:function(a){if(void 0===a)return this._e.style.height;this._e.style.height=
a+"px";return this},get:function(){return this._e},evt:function(a,b){this._e.addEventListener(a,b,!1);return this}};return{div:function(){return new c("div")},span:function(){return new c("span")},cav:function(){return new c("canvas")}}}();
mm3d.NO_TRANSFORM=0;mm3d.PAN_LEFT=1;mm3d.PAN_RIGHT=2;mm3d.PAN_TOP=3;mm3d.PAN_DOWN=4;mm3d.ROTATE=5;mm3d.ZOOM_IN=7;mm3d.ZOOM_OUT=8;mm3d.Widget=function(){this.base=null};mm3d.Widget.prototype={constructor:mm3d.Widget,getDOM:function(){return this.base.get()}};
mm3d.WgLoading=function(a){mm3d.Widget.call(this);var b=mm3d.Util.div().attr({className:"mm3dLoadingTitle"}).html("LOADING...");this.base=mm3d.Util.div().attr({className:"mm3dLoading"}).w(a[0]).h(a[1]);this._content=mm3d.Util.div().attr({className:"mm3dLoadingContent"});this.base.add(b).add(this._content);b.css({top:0.5*(a[1]-parseInt(b.get().clientHeight))+"px"})};mm3d.WgLoading.prototype=new mm3d.Widget;mm3d.WgLoading.prototype.content=function(a){this._content.html(a);return this};
mm3d.WgLoading.prototype.constructor=mm3d.WgLoading;
mm3d.WgToolbox=function(){var a=(new mm3d.Util.span).html("help").attr({className:"mm3dMenuItem"}).evt("click",function(){window.open("https://github.com/alpha360x/megamap/wiki/Help")}),b=(new mm3d.Util.span).html("export").attr({className:"mm3dMenuItem"}),c=(new mm3d.Util.div).attr({className:"mm3dMenuBox"});this.exp2jpeg=(new mm3d.Util.div).html("export2jpeg").attr({className:"mm3dBoxItem"});this.exp2png=(new mm3d.Util.div).html("export2png").attr({className:"mm3dBoxItem"});this.base=(new mm3d.Util.div).attr({className:"mm3dToolbox"}).add(b.add(c.add(this.exp2jpeg).add(this.exp2png))).add(a)};
mm3d.WgToolbox.prototype=new mm3d.Widget;mm3d.WgToolbox.prototype.constructor=mm3d.WgToolbox;mm3d.WgTitle=function(a){this.base=(new mm3d.Util.div).html(void 0===a?"":a).attr({className:"mm3dTitle"})};mm3d.WgTitle.prototype=new mm3d.Widget;mm3d.WgTitle.prototype.content=function(a){this.base.html(a);return this};mm3d.WgTitle.prototype.constructor=mm3d.WgTitle;
mm3d.WgScalerule=function(a){(new mm3d.Util.div).attr({className:"mm3dScaleRule"}).w(a[0]).h(a[1]);var b=(new mm3d.Util.cav).attr({width:a[0],height:a[1],className:"mm3dScaleRule"});this._min=(new mm3d.Util.span).attr({id:"mm3dMinTag",className:"mm3dScaleTag"});this._max=(new mm3d.Util.span).attr({id:"mm3dMaxTag",className:"mm3dScaleTag"});this._size=a;this._ctx=b.get().getContext("2d");this.repaint=function(a,b){var e=this._ctx.createLinearGradient(0,0,this._size[0],this._size[1]);e.addColorStop(0,
a);e.addColorStop(1,b);this._ctx.fillStyle=e;this._ctx.fillRect(0,0,this._size[0],this._size[1]);return this};this.repaint("#f00","#ff0");this.base=(new mm3d.Util.div).attr({className:"mm3dScaleRuleCont"}).add(this._min).add(this._max).add(b)};mm3d.WgScalerule.prototype=new mm3d.Widget;mm3d.WgScalerule.prototype.max=function(a){if(void 0===a)return this._max.html();this._max.html(a);return this};mm3d.WgScalerule.prototype.min=function(a){if(void 0===a)return this._min.html();this._min.html(a);return this};
mm3d.WgScalerule.prototype.constructor=mm3d.WgScalerule;mm3d.WgLegend=function(a){this.base=(new mm3d.Util.div).attr({className:"mm3dLegendContainer"});this._ctx=(new mm3d.Util.div).attr({className:"mm3dLegendCtx"});this._node=(new mm3d.Util.div).attr({className:"mm3dLegend"}).h(a[1]/3);this.base.add(this._node.add(this._ctx))};mm3d.WgLegend.prototype=new mm3d.Widget;mm3d.WgLegend.prototype.repaint=function(a,b){for(var c=this._ctx.get();c.firstChild;)c.removeChild(c.firstChild);for(var d in a.model)this._ctx.add((new mm3d.Util.div).attr({className:"mm3dLegendItem"}).add((new mm3d.Util.span).attr({className:"mm3dLegendColor"}).css({backgroundColor:b.getColor(d).getContextStyle()})).add((new mm3d.Util.span).attr({className:"mm3dLegendName"}).html(d)).add((new mm3d.Util.span).attr({className:"mm3dLegendValue"}).html(a.model[d].data)))};
mm3d.WgLegend.prototype.constructor=mm3d.WgLegend;mm3d.WgCamCtrl=function(){this.base=mm3d.Util.div().attr({className:"mm3dCamContainer"});var a=Math.sqrt(2),a=[{pos:[2*a-1,a-1],sign:mm3d.PAN_TOP},{pos:[a-1,2*a-1],sign:mm3d.PAN_LEFT},{pos:[3*a-1,2*a-1],sign:mm3d.PAN_RIGHT},{pos:[2*a-1,3*a-1],sign:mm3d.PAN_DOWN}];this.bts={};for(var b=0;b<a.length;b++)this.bts[a[b].sign]=mm3d.Util.div().attr({className:"mm3dCamButton"}).css({left:18*a[b].pos[0]+"px",top:18*a[b].pos[1]+"px"}),this.base.add(this.bts[a[b].sign])};
mm3d.WgCamCtrl.prototype=new mm3d.Widget;mm3d.WgCamCtrl.prototype.constructor=mm3d.WgCamCtrl;
mm3d.Color=function(a){this._dataModel=a};mm3d.Color.prototype={constructor:mm3d.Color,getColor:function(){throw{message:"invalid invokes virtual class method."};}};mm3d.ColorLG=function(a,b,c){mm3d.Color.call(this,a);this.maxC=c;this.minC=b};mm3d.ColorLG.prototype=new mm3d.Color;mm3d.ColorLG.prototype.getColor=function(a){return this.getColorV(this._dataModel.model[a].data)};
mm3d.ColorLG.prototype.getColorV=function(a){var b=(a-this._dataModel.min)/this._dataModel.max,a=(this.maxC.r-this.minC.r)*b+this.minC.r,c=(this.maxC.g-this.minC.g)*b+this.minC.g,b=(this.maxC.b-this.minC.b)*b+this.minC.b;return(new THREE.Color).setRGB(a,c,b)};mm3d.ColorLG.prototype.constructor=mm3d.ColorLG;
var mm3d=mm3d||{};mm3d.BaseData=function(){this.model=null;this.min=this.max=this.length=0};mm3d.BaseData.FIELDS=["data","last","mesh","disp"];mm3d.BaseData.prototype={constructor:mm3d.BaseData,forEach:function(b,c){for(var a in this.model)c.call(this,a,this.model[b])},changeData:function(b,c){this.max=0;for(var a in this.model)b[a].data>this.max&&(this.max=b[a].data),this.model[a].data=b[a].data;void 0!==c&&(this.max=c)}};
mm3d.Map3D=function(b,a,e){this._dataModel=b;this._colorModel=a;this._maxBarHeight=50;void 0!==e?(this._size=void 0===e.size?[window.innerWidth,window.innerHeight]:e.size,this._urlPrefix="string"===typeof e.urlPrefix?e.urlPrefix:"map",void 0!==e.maxBarHeight&&(this._maxBarHeight=e.maxBarHeight)):(this._size=[window.innerWidth,window.innerHeight],this._urlPrefix="map");this._scene=new THREE.Scene;this._renderer=new THREE.WebGLRenderer({clearColor:0,clearAlpha:1});this._camera=new THREE.PerspectiveCamera(75,
this._size[0]/this._size[1],1,1E4);this._loader=new THREE.JSONLoader(!0);this._light=new THREE.PointLight(16777215);this._lookAt={x:0,y:0,z:0};this._camera.position.set(0,5,0);this._camera.up={x:0,y:0,z:-1};this._camera.lookAt(this._lookAt);this._scene.add(this._camera);this._light.position.set(0,5,0);this._scene.add(this._light);this._renderer.setSize(this._size[0],this._size[1])};
mm3d.Map3D.prototype={constructor:mm3d.Map3D,_listener:{loadStatus:[],load:[]},addEventListener:function(b,a){this._listener[b].push(a)},getDOM:function(){return this._renderer.domElement},aniScale:function(b,a){var e=b/a,c=this._dataModel.max,d=this._dataModel.min,g;for(g in this._dataModel.model){var f=this._dataModel.model[g];f.mesh.scale.y=f.last+(1+this._maxBarHeight*f.data/(c-d)-f.last)*e}if(b>=a){for(g in this._dataModel.model)this._dataModel.model[g].last=1+this._maxBarHeight*this._dataModel.model[g].data/
(c-d);return!0}return!1},repaint:function(b,a){var e=void 0===b?!0:b,c=void 0===a?!0:a,d=this._dataModel.max,g=this._dataModel.min;0===d-g&&(e=!1);for(var f in this._dataModel.model)if(c&&(this._dataModel.model[f].mesh.material=new THREE.MeshLambertMaterial({color:this._colorModel.getColor(f).getHex(),transparent:!0})),e){var h=1+this._maxBarHeight*this._dataModel.model[f].data/(d-g);this._dataModel.model[f].mesh.scale.y=h;this._dataModel.model[f].last=h}},loadMeshes:function(){var b=0,a;for(a in this._dataModel.model)(function(a,
c){c._loader.load({model:c._urlPrefix+a+".js",callback:function(d){b+=1;c._dataModel.model[a].mesh=new THREE.Mesh(d,new THREE.MeshLambertMaterial({color:16711680}));c._scene.add(c._dataModel.model[a].mesh);for(d=0;d<c._listener.loadStatus.length;d++)c._listener.loadStatus[d].call(c,{name:a,count:b});if(b>=c._dataModel.length)for(d=0;d<c._listener.load.length;d++)c._listener.load[d].call(c)}})})(a,this)},pan:function(b,a){if("number"===typeof a){switch(b){case mm3d.PAN_TOP:this._camera.position.z-=
a;this._lookAt.z-=a;break;case mm3d.PAN_DOWN:this._camera.position.z+=a;this._lookAt.z+=a;break;case mm3d.PAN_RIGHT:this._camera.position.x+=a;this._lookAt.x+=a;break;case mm3d.PAN_LEFT:this._camera.position.x-=a,this._lookAt.x-=a}this._camera.lookAt(this._lookAt)}},zoom:function(b){if("number"===typeof b){var a=this._camera.position,e=this._lookAt.x-a.x,c=this._lookAt.y-a.y,d=this._lookAt.z-a.z;a.x+=e*b;a.y+=c*b;a.z+=d*b;this._lookAt.x+=e*b;this._lookAt.y+=c*b;this._lookAt.z+=d*b;this._camera.position=
a;this._camera.lookAt=this._lookAt}},rotate:function(b){if(!("number"!==typeof b.x||"number"!==typeof b.y))for(var a in this._dataModel.model)this._dataModel.model[a].mesh.rotation.x+=b.x,this._dataModel.model[a].mesh.rotation.z+=b.y},render:function(){this._renderer.render(this._scene,this._camera)}};
mm3d.WIDGET_SCALERULE=0;mm3d.WIDGET_TOOLBOX=1;mm3d.WIDGET_TITLE=2;mm3d.WIDGET_CAMCTRL=3;mm3d.WIDGET_LEGEND=4;mm3d.AbstractMap=function(){this._mapDOM=this._map3D=null;this._transform={type:mm3d.NO_TRANSFORM,delta:0}};
mm3d.AbstractMap.prototype={_initConfig:function(b){this._colorModel=new mm3d.ColorLG(this._dataModel,new THREE.Color(16776960),new THREE.Color(16711680));this._size=[window.innerWidth,window.innerHeight];this._title="";this._ani={isRun:!1,cur:0,max:100};this._maxBarHeight=50;void 0!==b&&(void 0!==b.colorModel&&(this._colorModel=new mm3d.ColorLG(this._dataModel,b.colorModel.min,b.colorModel.max)),void 0!==b.size&&(this._size=b.size),void 0!==b.title&&(this._title=b.title),void 0!==b.maxBarHeight&&
(this._maxBarHeight=b.maxBarHeight),void 0!==b.animation&&b.animation&&(this._ani.isRun=!0),void 0!==b.animationStep&&(this._ani.max=b.animationStep));this._widgets=[new mm3d.WgScalerule([this._size[0]/3.9,this._size[1]/18]),new mm3d.WgToolbox,new mm3d.WgTitle(this._title),new mm3d.WgCamCtrl,new mm3d.WgLegend(this._size)];this._loading=new mm3d.WgLoading(this._size)},_listeners:{load:[]},_dispatchEvent:function(b){for(var a=0;a<this._listeners[b].length;a++)this._listeners[b][a].call(this)},_mainloop:function(b){return function(){requestAnimationFrame(b._mainloop(b));
b._renderScene()}},_export:function(b,a){return function(){window.open(b._mapDOM.toDataURL(a))}},_initToolbox:function(){var b=this._widgets[mm3d.WIDGET_TOOLBOX];b.exp2jpeg.evt("click",this._export(this,"image/jpeg"));b.exp2png.evt("click",this._export(this,"image/png"))},_initCamCtrl:function(){var b=this._widgets[mm3d.WIDGET_CAMCTRL],a;for(a in b.bts)b.bts[a].get().addEventListener("mousedown",function(a,b){return function(){a._transform.type=parseInt(b);a._transform.delta=0.1}}(this,a),!1),b.bts[a].get().addEventListener("mouseup",
function(a){return function(){a._transform.type=mm3d.NO_TRANSFORM}}(this),!1)},title:function(b){if(void 0===b)return this._title;this._title=b;this._widgets[mm3d.WIDGET_TITLE].content(b);return this},_renderScene:function(){switch(this._transform.type){case mm3d.PAN_TOP:case mm3d.PAN_LEFT:case mm3d.PAN_RIGHT:case mm3d.PAN_DOWN:this._map3D.pan(this._transform.type,this._transform.delta);break;case mm3d.ROTATE:this._map3D.rotate(this._transform.delta);break;case mm3d.ZOOM_OUT:case mm3d.ZOOM_IN:this._map3D.zoom(this._transform.delta)}this._ani.isRun&&
(this._ani.cur+=1,this._map3D.aniScale(this._ani.cur,this._ani.max)&&(this._ani.isRun=!1,this._ani.cur=0));this._map3D.render()},_noTransform:function(b){return function(){b._transform.type=mm3d.NO_TRANSFORM}},_rotationHandler:function(b){var a=0,c=0;return function(d){var e=d.clientX,d=d.clientY;b._transform.delta={y:0.5*-(e-a)/b._size[0],x:0.5*(d-c)/b._size[1]};a=e;c=d}},updateData:function(b,a){if(this._ani.isRun)return!1;var c=void 0;void 0!==a&&void 0!==a.maxval&&(c=a.maxval);this._dataModel.changeData(b,
c);this._widgets[mm3d.WIDGET_SCALERULE].max(this._dataModel.max).min(this._dataModel.min);this._widgets[mm3d.WIDGET_LEGEND].repaint(this._dataModel,this._colorModel);void 0!==a?(this._map3D._maxBarHeight=void 0===a.maxBarHeight?this._map3D._maxBarHeight:a.maxBarHeight,this._map3D.repaint(!a.animation,!0),this._ani.isRun=void 0===a.animation?!1:a.animation,this._ani.max=void 0===a.animationStep?this._ani.max:a.animationStep):this._map3D.repaint()},addEventListener:function(b,a){this._listeners[b].push(a)},
init:function(){for(var b=0;b<this._widgets.length;b++)this._vp.appendChild(this._widgets[b].getDOM());this._widgets[mm3d.WIDGET_SCALERULE].max(this._dataModel.max).min(this._dataModel.min).repaint(this._colorModel.minC.getContextStyle(),this._colorModel.maxC.getContextStyle());this._vp.appendChild(this._loading.getDOM());this._widgets[mm3d.WIDGET_LEGEND].repaint(this._dataModel,this._colorModel);window.addEventListener("keydown",function(a){return function(b){65===b.which?(a._transform.type=mm3d.ZOOM_IN,
a._transform.delta=0.03):90===b.which&&(a._transform.type=mm3d.ZOOM_OUT,a._transform.delta=-0.03)}}(this),!1);window.addEventListener("keyup",this._noTransform(this),!1);this._vp.addEventListener("mousemove",this._rotationHandler(this),!1);this._map3D=new mm3d.Map3D(this._dataModel,this._colorModel,{size:this._size,urlPrefix:this._urlPrefix,maxBarHeight:this._maxBarHeight});this._map3D.addEventListener("loadStatus",function(a){return function(b){a._loading.content(parseInt(100*(b.count/a._dataModel.length))+
"% loaded")}}(this));this._map3D.addEventListener("load",function(a){return function(){a._mapDOM=a._map3D.getDOM();a._mapDOM.className="mm3dMap";a._vp.removeChild(a._loading.getDOM());a._vp.appendChild(a._mapDOM);a._map3D.repaint(!a._ani.isRun,!0);a._mainloop(a)();a._mapDOM.addEventListener("mouseup",a._noTransform(a),!1);a._mapDOM.addEventListener("mousedown",function(a){return function(){a._transform.type=mm3d.ROTATE}}(a),!1);a._initCamCtrl();a._initToolbox();a._dispatchEvent("load")}}(this));this._map3D.loadMeshes()},
constructor:mm3d.AbstractMap};
