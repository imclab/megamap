if(!window.requestAnimationFrame){window.requestAnimationFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1000/60)}})()}var mm3d={};mm3d.EPSILON=0.0001;mm3d.baseHeight=0.5;mm3d.LINEAR_GRADIENT=0;mm3d.PAN_TOP=4;mm3d.PAN_LEFT=1;mm3d.PAN_RIGHT=2;mm3d.PAN_DOWN=3;mm3d.ANI_SCALE_BAR=0;mm3d.sortData=function(d,c){return -d.data+c.data};mm3d.mouseState={down:false,keyDown:false,zoomIn:true,pan:0,last:{x:0,y:0},cur:{x:0,y:0}};mm3d.ChineseMap=function(a,c,b){if(typeof a!=="object"){throw {message:"Cannot intialize with null container."}}else{this._vp=a}this._option={size:[window.innerWidth,window.innerHeight],colorModel:{type:mm3d.LINEAR_GRADIENT,start:new THREE.Color(16776960),end:new THREE.Color(16711680),stops:[]},showLegend:true};this.title="";this.minVal=this.maxVal=0;this._modelChanged=false;this._data={};this._data.model={Zhejiang:{data:0,last:0},Jiangsu:{data:0,last:0},Shandong:{data:0,last:0},Anhui:{data:0,last:0},Shanghai:{data:0,last:0},Hebei:{data:0,last:0},Jiangxi:{data:0,last:0},Henan:{data:0,last:0},Hainan:{data:0,last:0},Taiwan:{data:0,last:0},Hunan:{data:0,last:0},Sichuan:{data:0,last:0},Yunnan:{data:0,last:0},Gansu:{data:0,last:0},Xizang:{data:0,last:0},Liaoning:{data:0,last:0},Jilin:{data:0,last:0},Heilongjiang:{data:0,last:0},Hubei:{data:0,last:0},Shaanxi:{data:0,last:0},Neimenggu:{data:0,last:0},Guangxi:{data:0,last:0},Qinghai:{data:0,last:0},Ningxia:{data:0,last:0},Xinjiang:{data:0,last:0},Chongqing:{data:0,last:0},Shanxi:{data:0,last:0},Tianjing:{data:0,last:0},Beijing:{data:0,last:0},Guangdong:{data:0,last:0},Guizhou:{data:0,last:0},Hongkong:{data:0,last:0},Macau:{data:0,last:0},Fujian:{data:0,last:0}};this._data.length=(function(f){var d=0;for(var e in f){d++}return function(){return d}})(this._data.model);if(typeof b==="object"){this._option.size=b.size instanceof Array?b.size:this._option.size;this._option.showLegend=typeof b.showLegend==="boolean"?b.showLegend:this._option.showLegend;this._option.colorModel=typeof b.colorModel==="object"?b.colorModel:this._option.colorModel;this.title=typeof b.title==="string"?b.title:this.title;this._aniStatus.isRun=typeof b.animate==="boolean"?b.animate:false;if(this._aniStatus.isRun){this._aniStatus.maxStep=typeof b.animateStep==="number"?b.animateStep:100}else{this._aniStatus.maxStep=this._aniStatus.step=100}}if(c!==undefined){this._changeData(c)}this._calMax();this._lookAtPos={x:0,y:0,z:0}};mm3d.ChineseMap.prototype={_listeners:{load:[]},addEventListener:function(a,b){this._listeners[a].push(b)},_loadComplete:false,_calMax:function(){this.maxVal=0;for(var a in this._data.model){this.maxVal=this._data.model[a]["data"]>this.maxVal?this._data.model[a]["data"]:this.maxVal}this._maxbarHeight=this.maxVal>39.125?39.125:this.maxVal;if(this.maxVal===0){this._maxbarHeight=this.maxVal=1}},_calColor:function(e){var d=e/this._maxbarHeight;var c=this._option.colorModel.start;var b=this._option.colorModel.end;var a=new THREE.Color(0);a.setRGB(d*(b.r-c.r)+c.r,d*(b.g-c.g)+c.g,d*(b.b-c.b)+c.b);return a},_initLoading:function(){this._loadingNode=document.createElement("div");this._loadingNode.id="mm3dLoading";this._loadingNode.style["width"]=this._option.size[0]+"px";this._loadingNode.style["height"]=this._option.size[1]+"px";var b=document.createElement("div");b.className="mm3dLoadingTitle";b.innerHTML="LOADING ...";var a=document.createElement("div");a.className="mm3dLoadingContent";this._loadingNode.changeContent=(function(c){return function(d){a.innerHTML=d}})(a);this._loadingNode.appendChild(b);this._loadingNode.appendChild(a);this._vp.appendChild(this._loadingNode);b.style["top"]=(this._option.size[1]-parseInt(b.clientHeight))*0.5+"px";a.style["top"]=(this._option.size[1]+parseInt(b.clientHeight))*0.5+"px"},_initCamCtrl:function(){this._camNode=document.createElement("div");this._camNode.id="mm3dCamContainer";var d=18;var e=Math.sqrt(2);var a=[{pos:[2*e-1,e-1],sign:mm3d.PAN_TOP},{pos:[e-1,2*e-1],sign:mm3d.PAN_LEFT},{pos:[3*e-1,2*e-1],sign:mm3d.PAN_RIGHT},{pos:[2*e-1,3*e-1],sign:mm3d.PAN_DOWN}];for(var c=0;c<a.length;c++){var b=document.createElement("div");b.className="mm3dCamButton";b.style["left"]=d*a[c]["pos"][0]+"px";b.style["top"]=d*a[c]["pos"][1]+"px";b.addEventListener("mousedown",(function(f){return function(){mm3d.mouseState.pan=f;mm3d.mouseState.down=true}})(a[c]["sign"]),false);b.addEventListener("mouseup",function(f){mm3d.mouseState.down=false},false);this._camNode.appendChild(b)}this._vp.appendChild(this._camNode)},_repaintLegend:function(){for(;this._legendContext.childNodes.length>0;){this._legendContext.removeChild(this._legendContext.firstChild)}for(var c in this._data.model){var a=document.createElement("div");a.className="mm3dLegendItem";var b=document.createElement("span");b.className="mm3dLegendColor";b.style["backgroundColor"]=this._calColor(this._data.model[c]["data"]*this._maxbarHeight/this.maxVal).getContextStyle();var e=document.createElement("span");e.className="mm3dLegendName";e.innerHTML=c;var d=document.createElement("span");d.className="mm3dLegendValue";d.innerHTML=this._data.model[c]["data"];a.appendChild(b);a.appendChild(e);a.appendChild(d);this._legendContext.appendChild(a)}},_initLegend:function(){var a=document.createElement("div");a.id="mm3dLegendContainer";var c=document.createElement("div");c.className="mm3dLegendToolbar";var b=document.createElement("div");b.id="mm3dLegend";b.style["height"]=parseInt(this._option.size[1]/3/30)*30+"px";this._legendContext=document.createElement("div");this._legendContext.id="mm3dLegendCtx";this._repaintLegend();b.appendChild(this._legendContext);a.appendChild(b);this._vp.appendChild(a)},_mkTitle:function(){if(this._titleNode===undefined){this._titleNode=document.createElement("div");this._titleNode.id="mm3dTitle";this._titleNode.innerHTML=this.title;this._vp.appendChild(this._titleNode)}else{this._titleNode.innerHTML=this.title}},_aniStatus:{isRun:false,step:0,maxStep:100,type:0},setTitle:function(a){this.title=a;this._mkTitle()},init:function(){var l=document.createElement("div");var n=document.createElement("span");var i=function(q,r){for(attr in r){q[attr]=r[attr]}};this._vp.addEventListener("mousedown",function(q){mm3d.mouseState.down=true},false);this._vp.addEventListener("mouseup",function(q){mm3d.mouseState.down=false;mm3d.mouseState.pan=0},false);this._vp.addEventListener("mousemove",function(q){mm3d.mouseState.last=mm3d.mouseState.cur;mm3d.mouseState.cur={x:q.clientX,y:q.clientY}},false);window.addEventListener("keydown",function(q){switch(q.which){case 65:mm3d.mouseState.keyDown=true;mm3d.mouseState.zoomIn=true;break;case 90:mm3d.mouseState.keyDown=true;mm3d.mouseState.zoomIn=false;break;default:break}},false);window.addEventListener("keyup",function(q){mm3d.mouseState.keyDown=false},false);var j=l.cloneNode(true);i(j,{id:"mm3dToolBox",className:"mm3dToolBox"});var a=n.cloneNode(true);i(a,{id:"mm3dOption",innerHTML:"option",className:"mm3dMenuItem"});a.addEventListener("click",function(q){alert("option")},false);var f=n.cloneNode(true);i(f,{id:"mm3dHelp",innerHTML:"help",className:"mm3dMenuItem"});f.addEventListener("click",function(q){alert("help")},false);var h=n.cloneNode(true);i(h,{id:"mm3dExport",innerHTML:"export",className:"mm3dMenuItem"});h.addEventListener("click",function(q){alert("export")},false);j.appendChild(h);j.appendChild(a);j.appendChild(f);this._vp.appendChild(j);var g=l.cloneNode(true);i(g,{id:"mm3dScaleRuleCont"});this._scaleRule=g;var b=l.cloneNode(true);var m=this._option.size[0]/3.9;var e=this._option.size[1]/18;i(b,{id:"mm3dScaleRule"});b.style=b.style===undefined?{}:b.style;i(b.style,{width:m+"px",height:e+"px"});var p=document.createElement("canvas");p.width=m;p.height=e;b.appendChild(p);this._minTag=n.cloneNode(true);this._minTag.innerHTML=this.minVal;i(this._minTag,{id:"mm3dMinTag",className:"mm3dScaleTag"});this._maxTag=n.cloneNode(true);this._maxTag.innerHTML=this.maxVal;i(this._maxTag,{id:"mm3dMaxTag",className:"mm3dScaleTag"});g.appendChild(this._minTag);g.appendChild(this._maxTag);g.appendChild(b);this._vp.appendChild(g);var d=p.getContext("2d");var k=d.createLinearGradient(0,0,m,e);k.addColorStop(0,this._option.colorModel["start"].getContextStyle());k.addColorStop(1,this._option.colorModel["end"].getContextStyle());d.fillStyle=k;d.fillRect(0,0,m,e);this._initLoading();this._initLegend();this._initCamCtrl();this._mkTitle();this._three={scene:new THREE.Scene(),renderer:new THREE.WebGLRenderer({clearColor:0,clearAlpha:1}),camera:new THREE.PerspectiveCamera(75,this._option.size[0]/this._option.size[1],1,10000),loader:new THREE.JSONLoader(true),light:new THREE.PointLight(16777215)};this._three.camera.position.set(0,5,0);this._three.camera.up={x:0,y:0,z:-1};this._three.camera.lookAt(this._lookAtPos);this._three.scene.add(this._three.camera);this._three.light.position.set(0,5,0);this._three.scene.add(this._three.light);this._three.renderer.setSize(this._option.size[0],this._option.size[1]);this._three.scene.add(this._three.camera);this._loadedMesh=[];this._renderScene=function(){if(this._aniStatus.isRun){var C=this._aniStatus;this._aniStatus.step+=1;if(C.step>=C.maxStep){C.step=0;this._aniStatus.isRun=false}else{this._animator()}}if(this._modelChanged){this._repaintModel();this._maxTag.innerHTML=this.maxVal}if(mm3d.mouseState.down){if(mm3d.mouseState.pan!==0){var B=0.05;switch(mm3d.mouseState.pan){case mm3d.PAN_TOP:this._three.camera.position.z-=B;this._lookAtPos.z-=B;break;case mm3d.PAN_DOWN:this._three.camera.position.z+=B;this._lookAtPos.z+=B;break;case mm3d.PAN_RIGHT:this._three.camera.position.x+=B;this._lookAtPos.x+=B;break;case mm3d.PAN_LEFT:this._three.camera.position.x-=B;this._lookAtPos.x-=B;break;default:break}this._three.camera.lookAt(this._lookAtPos)}else{var x=mm3d.mouseState.cur.x,w=mm3d.mouseState.cur.y;var u=mm3d.mouseState.last.x,t=mm3d.mouseState.last.y;var v=w-t,y=-x+u;if(Math.abs(v)>mm3d.EPSILON||Math.abs(y)>mm3d.EPSILON){var z=v*0.5*Math.PI/this._option.size[1];var A=y*0.5*Math.PI/this._option.size[0];for(o in this._data.model){this._data.model[o]["mesh"].rotation.x+=z;this._data.model[o]["mesh"].rotation.z+=A}}}}else{if(mm3d.mouseState.keyDown){console.log("asfd");var r=this._three.camera.position;var q={x:this._lookAtPos.x-r.x,y:this._lookAtPos.y-r.y,z:this._lookAtPos.z-r.z};var s=0.005;if(mm3d.mouseState.zoomIn){r.x+=q.x*s;r.y+=q.y*s;r.z+=q.z*s;this._lookAtPos.x+=q.x*s;this._lookAtPos.y+=q.y*s;this._lookAtPos.z+=q.z*s}else{r.x-=q.x*s;r.y-=q.y*s;r.z-=q.z*s;this._lookAtPos.x-=q.x*s;this._lookAtPos.y-=q.y*s;this._lookAtPos.z-=q.z*s}this._three.camera.position=r;this._three.camera.lookAt(this._lookAtPos)}}this._three.renderer.render(this._three.scene,this._three.camera)};this._mainloop=function(q){return function(){requestAnimationFrame(q._mainloop(q));q._renderScene()}};var c=this._data.length();for(var o in this._data.model){(function(s,r,q){s._three.loader.load({model:"js/map"+r+".js",callback:function(v){s._loadedMesh.push(r);var u=s._data.model[r]["data"]/s.maxVal*s._maxbarHeight;s._data.model[r]["mesh"]=new THREE.Mesh(v,new THREE.MeshLambertMaterial({color:s._calColor(u).getHex(),transparent:true}));s._three.scene.add(s._data.model[r]["mesh"]);s._loadingNode.changeContent("Mesh "+r+" loaded. "+(s._loadedMesh.length/q)*100+"%");if(s._loadedMesh.length>=q){console.log("loads complete.");s._loadComplete=true;for(var t=0;t<s._listeners.load.length;t++){s._listeners.load[t].call()}s._vp.removeChild(s._loadingNode);if(!s._aniStatus.isRun){s._animator()}s._mainloop(s)()}}})})(this,o,c)}this._three.renderer.domElement.id="mm3dViewport";this._vp.appendChild(this._three.renderer.domElement)},_repaintModel:function(){for(var a in this._data.model){var c=this._data.model[a]["mesh"];var b=this._data.model[a]["data"]/this.maxVal*this._maxbarHeight;c.material=new THREE.MeshLambertMaterial({color:this._calColor(b).getHex(),transparent:true})}this._modelChanged=false},_animator:function(){if(this._loadComplete){for(var b in this._data.model){var c=this._data.model[b];var d=c.data;var a=c.last;c.mesh.scale.y=1+(a+(d-a)*this._aniStatus.step/this._aniStatus.maxStep)/this.maxVal*this._maxbarHeight}}},change:function(a){},_changeData:function(b){for(var c in b){this._data.model[c]["last"]=this._data.model[c]["data"];for(var a in b[c]){this._data.model[c][a]=b[c][a]}}this._calMax();this._modelChanged=true},changeData:function(b,a){this._changeData(b);if(a===undefined){this._aniStatus.maxStep=this._aniStatus.step=100;this._animator()}else{this._aniStatus.step=0;this._aniStatus.isRun=true;this._aniStatus.maxStep=a.step===undefined?100:a.step;this._animator()}},changeScale:function(c,a,b){this._maxbarHeight=c;if(!this._loadComplete){return false}if(!this._aniStatus.isRun){if(a===undefined||a===false){this._aniStatus.step=this._aniStatus.maxStep=100;this._animator()}else{this._aniStatus.isRun=true;this._aniStatus.step=0;this._aniStatus.maxStep=typeof b==="number"?b:100;this._animator()}return true}return false}};